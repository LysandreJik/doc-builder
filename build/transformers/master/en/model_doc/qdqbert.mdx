---
local: qdqbert
sections:
- local: overview
  sections:
  - local: set-default-quantizers
    title: Set default quantizers
  - local: calibration
    title: Calibration
  - local: export-to-onnx
    title: Export to ONNX
  title: Overview
- local: transformers.QDQBertConfig
  title: QDQBertConfig
- local: transformers.QDQBertModel
  title: QDQBertModel
- local: transformers.QDQBertLMHeadModel
  title: QDQBertLMHeadModel
- local: transformers.QDQBertForMaskedLM
  title: QDQBertForMaskedLM
- local: transformers.QDQBertForSequenceClassification
  title: QDQBertForSequenceClassification
- local: transformers.QDQBertForNextSentencePrediction
  title: QDQBertForNextSentencePrediction
- local: transformers.QDQBertForMultipleChoice
  title: QDQBertForMultipleChoice
- local: transformers.QDQBertForTokenClassification
  title: QDQBertForTokenClassification
- local: transformers.QDQBertForQuestionAnswering
  title: QDQBertForQuestionAnswering
title: QDQBERT
---
<script>
import Tip from "./Tip.svelte";
import Youtube from "./Youtube.svelte";
import Docstring from "./Docstring.svelte";
import CodeBlock from "./CodeBlock.svelte";
import CodeBlockFw from "./CodeBlockFw.svelte";
import IconCopyLink from "./IconCopyLink.svelte";

export let fw: "pt" | "tf"
</script>

<!--Copyright 2021 NVIDIA Corporation and The HuggingFace Team. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
the License. You may obtain a copy of the License at

http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
specific language governing permissions and limitations under the License.
-->

<h1 id="qdqbert">QDQBERT</h1>

<h2 id="overview">Overview</h2>

The QDQBERT model can be referenced in [Integer Quantization for Deep Learning Inference: Principles and Empirical
Evaluation](https://arxiv.org/abs/2004.09602) by Hao Wu, Patrick Judd, Xiaojie Zhang, Mikhail Isaev and Paulius
Micikevicius.

The abstract from the paper is the following:

*Quantization techniques can reduce the size of Deep Neural Networks and improve inference latency and throughput by
taking advantage of high throughput integer instructions. In this paper we review the mathematical aspects of
quantization parameters and evaluate their choices on a wide range of neural network models for different application
domains, including vision, speech, and language. We focus on quantization techniques that are amenable to acceleration
by processors with high-throughput integer math pipelines. We also present a workflow for 8-bit quantization that is
able to maintain accuracy within 1% of the floating-point baseline on all networks studied, including models that are
more difficult to quantize, such as MobileNets and BERT-large.*

Tips:

- QDQBERT model adds fake quantization operations (pair of QuantizeLinear/DequantizeLinear ops) to (i) linear layer
  inputs and weights, (ii) matmul inputs, (iii) residual add inputs, in BERT model.

- QDQBERT requires the dependency of [Pytorch Quantization Toolkit](https://github.com/NVIDIA/TensorRT/tree/master/tools/pytorch-quantization). To install `pip install pytorch-quantization --extra-index-url https://pypi.ngc.nvidia.com`

- QDQBERT model can be loaded from any checkpoint of HuggingFace BERT model (for example *bert-base-uncased*), and
  perform Quantization Aware Training/Post Training Quantization.

- A complete example of using QDQBERT model to perform Quatization Aware Training and Post Training Quantization for
  SQUAD task can be found at [transformers/examples/research_projects/quantization-qdqbert/](examples/research_projects/quantization-qdqbert/).

This model was contributed by [shangz](https://huggingface.co/shangz).


<h3 id="set-default-quantizers">Set default quantizers</h3>

QDQBERT model adds fake quantization operations (pair of QuantizeLinear/DequantizeLinear ops) to BERT by
`TensorQuantizer` in [Pytorch Quantization Toolkit](https://github.com/NVIDIA/TensorRT/tree/master/tools/pytorch-quantization). `TensorQuantizer` is the module
for quantizing tensors, with `QuantDescriptor` defining how the tensor should be quantized. Refer to [Pytorch
Quantization Toolkit userguide](https://docs.nvidia.com/deeplearning/tensorrt/pytorch-quantization-toolkit/docs/userguide.html) for more details.

Before creating QDQBERT model, one has to set the default `QuantDescriptor` defining default tensor quantizers.
Example:

```
>>> import pytorch_quantization.nn as quant_nn
>>> from pytorch_quantization.tensor_quant import QuantDescriptor

>>> # The default tensor quantizer is set to use Max calibration method
>>> input_desc = QuantDescriptor(num_bits=8, calib_method="max")
>>> # The default tensor quantizer is set to be per-channel quantization for weights
>>> weight_desc = QuantDescriptor(num_bits=8, axis=((0,)))
>>> quant_nn.QuantLinear.set_default_quant_desc_input(input_desc)
>>> quant_nn.QuantLinear.set_default_quant_desc_weight(weight_desc)
```

<h3 id="calibration">Calibration</h3>

Calibration is the terminology of passing data samples to the quantizer and deciding the best scaling factors for
tensors. After setting up the tensor quantizers, one can use the following example to calibrate the model:

```
>>> # Find the TensorQuantizer and enable calibration
>>> for name, module in model.named_modules():
>>>     if name.endswith('_input_quantizer'):
>>>         module.enable_calib()
>>>         module.disable_quant()  # Use full precision data to calibrate

>>> # Feeding data samples
>>> model(x)
>>> # ...

>>> # Finalize calibration
>>> for name, module in model.named_modules():
>>>     if name.endswith('_input_quantizer'):
>>>         module.load_calib_amax()
>>>         module.enable_quant()

>>> # If running on GPU, it needs to call .cuda() again because new tensors will be created by calibration process
>>> model.cuda()

>>> # Keep running the quantized model
>>> # ...
```

<h3 id="export-to-onnx">Export to ONNX</h3>

The goal of exporting to ONNX is to deploy inference by [TensorRT](https://developer.nvidia.com/tensorrt). Fake
quantization will be broken into a pair of QuantizeLinear/DequantizeLinear ONNX ops. After setting static member of
TensorQuantizer to use Pytorchâ€™s own fake quantization functions, fake quantized model can be exported to ONNX, follow
the instructions in [torch.onnx](https://pytorch.org/docs/stable/onnx.html). Example:

```
>>> from pytorch_quantization.nn import TensorQuantizer
>>> TensorQuantizer.use_fb_fake_quant = True

>>> # Load the calibrated model
>>> ...
>>> # ONNX export
>>> torch.onnx.export(...)
```

<h2 id="transformers.QDQBertConfig">QDQBertConfig</h2>

<div class="docstring">

<docstring><name>class transformers.QDQBertConfig</name><anchor>transformers.QDQBertConfig</anchor><source>https://github.com/huggingface/transformers/blob/master/src/transformers/models/qdqbert/configuration_qdqbert.py#L29</source><parameters>[{"name": "vocab_size", "val": " = 30522"}, {"name": "hidden_size", "val": " = 768"}, {"name": "num_hidden_layers", "val": " = 12"}, {"name": "num_attention_heads", "val": " = 12"}, {"name": "intermediate_size", "val": " = 3072"}, {"name": "hidden_act", "val": " = 'gelu'"}, {"name": "hidden_dropout_prob", "val": " = 0.1"}, {"name": "attention_probs_dropout_prob", "val": " = 0.1"}, {"name": "max_position_embeddings", "val": " = 512"}, {"name": "type_vocab_size", "val": " = 2"}, {"name": "initializer_range", "val": " = 0.02"}, {"name": "layer_norm_eps", "val": " = 1e-12"}, {"name": "use_cache", "val": " = True"}, {"name": "is_encoder_decoder", "val": " = False"}, {"name": "pad_token_id", "val": " = 1"}, {"name": "bos_token_id", "val": " = 0"}, {"name": "eos_token_id", "val": " = 2"}, {"name": "**kwargs", "val": ""}]</parameters><paramsdesc>- **vocab_size** (`int`, _optional_, defaults to 30522) --
  Vocabulary size of the QDQBERT model. Defines the number of different tokens that can be represented by the
  `inputs_ids` passed when calling [QDQBertModel](/docs/transformers/master/en/model_doc/qdqbert#transformers.QDQBertModel).
- **hidden_size** (`int`, _optional_, defaults to 768) --
  Dimension of the encoder layers and the pooler layer.
- **num_hidden_layers** (`int`, _optional_, defaults to 12) --
  Number of hidden layers in the Transformer encoder.
- **num_attention_heads** (`int`, _optional_, defaults to 12) --
  Number of attention heads for each attention layer in the Transformer encoder.
- **intermediate_size** (`int`, _optional_, defaults to 3072) --
  Dimension of the "intermediate" (i.e., feed-forward) layer in the Transformer encoder.
- **hidden_act** (`str` or `function`, _optional_, defaults to `"gelu"`) --
  The non-linear activation function (function or string) in the encoder and pooler. If string,
  `"gelu"`, `"relu"`, `"selu"` and `"gelu_new"` are supported.
- **hidden_dropout_prob** (`float`, _optional_, defaults to 0.1) --
  The dropout probabilitiy for all fully connected layers in the embeddings, encoder, and pooler.
- **attention_probs_dropout_prob** (`float`, _optional_, defaults to 0.1) --
  The dropout ratio for the attention probabilities.
- **max_position_embeddings** (`int`, _optional_, defaults to 512) --
  The maximum sequence length that this model might ever be used with. Typically set this to something large
  just in case (e.g., 512 or 1024 or 2048).
- **type_vocab_size** (`int`, _optional_, defaults to 2) --
  The vocabulary size of the `token_type_ids` passed when calling [QDQBertModel](/docs/transformers/master/en/model_doc/qdqbert#transformers.QDQBertModel).
- **initializer_range** (`float`, _optional_, defaults to 0.02) --
  The standard deviation of the truncated_normal_initializer for initializing all weight matrices.
- **layer_norm_eps** (`float`, _optional_, defaults to 1e-12) --
  The epsilon used by the layer normalization layers.
- **use_cache** (`bool`, _optional_, defaults to `True`) --
  Whether or not the model should return the last key/values attentions (not used by all models). Only
  relevant if `config.is_decoder=True`.</paramsdesc><paramgroups>0</paramgroups></docstring>

This is the configuration class to store the configuration of a [QDQBertModel](/docs/transformers/master/en/model_doc/qdqbert#transformers.QDQBertModel). It is used to
instantiate an QDQBERT model according to the specified arguments, defining the model architecture. Instantiating a
configuration with the defaults will yield a similar configuration to that of the BERT [bert-base-uncased](https://huggingface.co/bert-base-uncased) architecture.

Configuration objects inherit from [PretrainedConfig](/docs/transformers/master/en/main_classes/configuration#transformers.PretrainedConfig) and can be used to control the model
outputs. Read the documentation from [PretrainedConfig](/docs/transformers/master/en/main_classes/configuration#transformers.PretrainedConfig) for more information.




Examples:

```python
>>> from transformers import QDQBertModel, QDQBertConfig

>>> # Initializing a QDQBERT bert-base-uncased style configuration
>>> configuration = QDQBertConfig()

>>> # Initializing a model from the bert-base-uncased style configuration
>>> model = QDQBertModel(configuration)

>>> # Accessing the model configuration
>>> configuration = model.config
```


</div>

<h2 id="transformers.QDQBertModel">QDQBertModel</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertLMHeadModel">QDQBertLMHeadModel</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForMaskedLM">QDQBertForMaskedLM</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForSequenceClassification">QDQBertForSequenceClassification</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForNextSentencePrediction">QDQBertForNextSentencePrediction</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForMultipleChoice">QDQBertForMultipleChoice</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForTokenClassification">QDQBertForTokenClassification</h2>

<div class="docstring">

<div class="docstring"></div></div>

<h2 id="transformers.QDQBertForQuestionAnswering">QDQBertForQuestionAnswering</h2>

<div class="docstring">

<div class="docstring"></div></div>
